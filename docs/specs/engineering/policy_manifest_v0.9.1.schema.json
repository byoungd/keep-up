{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/lfcc/policy_manifest_v0.9.1.schema.json",
  "type": "object",
  "required": [
    "lfcc_version",
    "policy_id",
    "coords",
    "anchor_encoding",
    "crdt_config",
    "structure_mode",
    "block_id_policy",
    "chain_policy",
    "partial_policy",
    "integrity_policy",
    "canonicalizer_policy",
    "history_policy",
    "ai_sanitization_policy",
    "relocation_policy",
    "dev_tooling_policy",
    "capabilities",
    "conformance_kit_policy",
    "v"
  ],
  "properties": {
    "lfcc_version": { "const": "0.9.1" },
    "policy_id": { "type": "string", "minLength": 1 },
    "coords": {
      "type": "object",
      "required": ["kind"],
      "properties": { "kind": { "const": "utf16" } },
      "additionalProperties": false
    },
    "anchor_encoding": {
      "type": "object",
      "required": ["version", "format"],
      "properties": {
        "version": { "type": "string", "minLength": 1 },
        "format": { "enum": ["base64", "bytes"] }
      },
      "additionalProperties": false
    },
    "crdt_config": {
      "type": "object",
      "required": ["engine", "frontier_format"],
      "properties": {
        "engine": { "const": "loro" },
        "frontier_format": { "const": "loro_op_ids_v1" }
      },
      "additionalProperties": false
    },
    "structure_mode": { "enum": ["A", "B"] },
    "block_id_policy": {
      "type": "object",
      "required": ["version", "overrides"],
      "properties": {
        "version": { "type": "string", "minLength": 1 },
        "overrides": {
          "type": "object",
          "propertyNames": {
            "enum": [
              "OP_BLOCK_CONVERT",
              "OP_LIST_REPARENT",
              "OP_TABLE_STRUCT",
              "OP_IMMUTABLE_REWRITE"
            ]
          },
          "additionalProperties": { "enum": ["KEEP_ID", "REPLACE_ID"] }
        }
      },
      "additionalProperties": false
    },
    "chain_policy": {
      "type": "object",
      "required": ["version", "defaults"],
      "properties": {
        "version": { "type": "string" },
        "defaults": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "required": ["kind", "max_intervening_blocks"],
            "properties": {
              "kind": { "enum": ["strict_adjacency", "required_order", "bounded_gap"] },
              "max_intervening_blocks": { "type": "integer", "minimum": 0 }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "partial_policy": {
      "type": "object",
      "required": ["version", "defaults"],
      "properties": {
        "version": { "type": "string" },
        "defaults": {
          "type": "object",
          "additionalProperties": { "enum": ["allow_drop_tail", "allow_islands", "none"] }
        }
      },
      "additionalProperties": false
    },
    "integrity_policy": {
      "type": "object",
      "required": ["version", "context_hash", "chain_hash", "document_checksum", "checkpoint"],
      "properties": {
        "version": { "type": "string" },
        "context_hash": {
          "type": "object",
          "required": ["enabled", "mode", "debounce_ms"],
          "properties": {
            "enabled": { "type": "boolean" },
            "mode": { "enum": ["lazy_verify", "eager"] },
            "debounce_ms": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "chain_hash": {
          "type": "object",
          "required": ["enabled", "mode"],
          "properties": {
            "enabled": { "type": "boolean" },
            "mode": { "enum": ["eager", "lazy_verify"] }
          },
          "additionalProperties": false
        },
        "document_checksum": {
          "type": "object",
          "required": ["enabled", "mode", "strategy", "algorithm"],
          "properties": {
            "enabled": { "type": "boolean" },
            "mode": { "enum": ["lazy_verify", "eager"] },
            "strategy": { "const": "two_tier" },
            "algorithm": { "const": "LFCC_DOC_V1" }
          },
          "additionalProperties": false
        },
        "checkpoint": {
          "type": "object",
          "required": ["enabled", "every_ops", "every_ms"],
          "properties": {
            "enabled": { "type": "boolean" },
            "every_ops": { "type": "integer", "minimum": 1 },
            "every_ms": { "type": "integer", "minimum": 1 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "canonicalizer_policy": {
      "type": "object",
      "required": ["version", "mode", "mark_order", "normalize_whitespace", "drop_empty_nodes"],
      "properties": {
        "version": { "const": "v3" },
        "mode": { "const": "recursive_tree" },
        "mark_order": {
          "type": "array",
          "items": { "enum": ["bold", "italic", "underline", "strike", "code", "link"] },
          "minItems": 1,
          "uniqueItems": true
        },
        "normalize_whitespace": { "type": "boolean" },
        "drop_empty_nodes": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "history_policy": {
      "type": "object",
      "required": [
        "version",
        "trusted_local_undo",
        "restore_enters_unverified",
        "restore_skip_grace",
        "force_verify_on_restore"
      ],
      "properties": {
        "version": { "const": "v1" },
        "trusted_local_undo": { "type": "boolean" },
        "restore_enters_unverified": { "type": "boolean" },
        "restore_skip_grace": { "type": "boolean" },
        "force_verify_on_restore": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "ai_sanitization_policy": {
      "type": "object",
      "required": [
        "version",
        "sanitize_mode",
        "allowed_marks",
        "allowed_block_types",
        "reject_unknown_structure",
        "limits"
      ],
      "properties": {
        "version": { "const": "v2" },
        "sanitize_mode": { "const": "whitelist" },
        "allowed_marks": {
          "type": "array",
          "items": { "enum": ["bold", "italic", "underline", "strike", "code", "link"] }
        },
        "allowed_block_types": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "reject_unknown_structure": { "type": "boolean" },
        "limits": {
          "type": "object",
          "required": ["max_payload_bytes", "max_nesting_depth", "max_attribute_count"],
          "properties": {
            "max_payload_bytes": { "type": "integer", "minimum": 1 },
            "max_nesting_depth": { "type": "integer", "minimum": 1 },
            "max_attribute_count": { "type": "integer", "minimum": 1 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "relocation_policy": {
      "type": "object",
      "required": [
        "version",
        "default_level",
        "enable_level_2",
        "enable_level_3",
        "level_2_max_distance_ratio",
        "level_3_max_block_radius"
      ],
      "properties": {
        "version": { "const": "v2" },
        "default_level": { "enum": [1, 2, 3] },
        "enable_level_2": { "type": "boolean" },
        "enable_level_3": { "type": "boolean" },
        "level_2_max_distance_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
        "level_3_max_block_radius": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false
    },
    "dev_tooling_policy": {
      "type": "object",
      "required": ["version", "force_full_scan_button", "state_visualizer"],
      "properties": {
        "version": { "const": "v2" },
        "force_full_scan_button": { "type": "boolean" },
        "state_visualizer": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "capabilities": {
      "type": "object",
      "required": [
        "cross_block_annotations",
        "bounded_gap",
        "tables",
        "reorder_blocks",
        "ai_replace_spans"
      ],
      "properties": {
        "cross_block_annotations": { "type": "boolean" },
        "bounded_gap": { "type": "boolean" },
        "tables": { "type": "boolean" },
        "reorder_blocks": { "type": "boolean" },
        "ai_replace_spans": { "type": "boolean" },
        "ai_gateway_v2": { "type": "boolean" },
        "ai_native": { "type": "boolean" },
        "ai_provenance": { "type": "boolean" },
        "ai_data_access": { "type": "boolean" },
        "ai_audit": { "type": "boolean" },
        "ai_transactions": { "type": "boolean" },
        "semantic_merge": { "type": "boolean" },
        "multi_agent": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "conformance_kit_policy": {
      "type": "object",
      "required": ["version", "kernel_recommended", "kernel_required_in_repo"],
      "properties": {
        "version": { "const": "v1" },
        "kernel_recommended": { "type": "boolean" },
        "kernel_required_in_repo": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "ai_native_policy": {
      "type": "object",
      "required": [
        "version",
        "gateway",
        "security",
        "data_access",
        "determinism",
        "intent_tracking",
        "provenance",
        "semantic_merge",
        "transactions",
        "ai_opcodes"
      ],
      "properties": {
        "version": { "const": "v1" },
        "gateway": {
          "type": "object",
          "required": ["max_ops_per_request", "max_payload_bytes", "idempotency_window_ms"],
          "properties": {
            "max_ops_per_request": { "type": "integer", "minimum": 1 },
            "max_payload_bytes": { "type": "integer", "minimum": 1 },
            "idempotency_window_ms": { "type": "integer", "minimum": 1 }
          },
          "additionalProperties": false
        },
        "security": {
          "type": "object",
          "required": [
            "require_signed_requests",
            "agent_token_ttl_ms",
            "audit_retention_days",
            "allow_external_models"
          ],
          "properties": {
            "require_signed_requests": { "type": "boolean" },
            "agent_token_ttl_ms": { "type": "integer", "minimum": 1 },
            "audit_retention_days": { "type": "integer", "minimum": 0 },
            "allow_external_models": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "data_access": {
          "type": "object",
          "required": [
            "max_context_chars",
            "redaction_strategy",
            "pii_handling",
            "allow_external_fetch"
          ],
          "properties": {
            "max_context_chars": { "type": "integer", "minimum": 0 },
            "redaction_strategy": { "enum": ["mask", "omit"] },
            "pii_handling": { "enum": ["block", "mask", "allow"] },
            "allow_external_fetch": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "determinism": {
          "type": "object",
          "required": ["require_explicit_ops"],
          "properties": {
            "require_explicit_ops": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "intent_tracking": {
          "type": "object",
          "required": ["enabled", "require_intent", "intent_retention_days"],
          "properties": {
            "enabled": { "type": "boolean" },
            "require_intent": { "type": "boolean" },
            "intent_retention_days": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "provenance": {
          "type": "object",
          "required": ["enabled", "track_inline", "require_model_id"],
          "properties": {
            "enabled": { "type": "boolean" },
            "track_inline": { "type": "boolean" },
            "require_model_id": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "semantic_merge": {
          "type": "object",
          "required": ["enabled", "ai_autonomy", "auto_merge_threshold"],
          "properties": {
            "enabled": { "type": "boolean" },
            "ai_autonomy": { "enum": ["disabled", "suggest_only", "full"] },
            "auto_merge_threshold": { "type": "number", "minimum": 0, "maximum": 1 }
          },
          "additionalProperties": false
        },
        "transactions": {
          "type": "object",
          "required": ["enabled", "default_timeout_ms", "max_operations_per_txn"],
          "properties": {
            "enabled": { "type": "boolean" },
            "default_timeout_ms": { "type": "integer", "minimum": 1 },
            "max_operations_per_txn": { "type": "integer", "minimum": 1 }
          },
          "additionalProperties": false
        },
        "ai_opcodes": {
          "type": "object",
          "required": ["allowed", "require_approval"],
          "properties": {
            "allowed": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "minItems": 1,
              "uniqueItems": true
            },
            "require_approval": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "uniqueItems": true
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "extensions": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["version", "min_compatible_version"],
        "properties": {
          "version": { "type": "string", "minLength": 1 },
          "min_compatible_version": { "type": "string", "minLength": 1 },
          "config": { "type": "object", "additionalProperties": true }
        },
        "additionalProperties": true
      }
    },
    "v": { "type": "integer", "minimum": 1 }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "ai_native_policy": {
            "required": ["semantic_merge"],
            "properties": {
              "semantic_merge": {
                "required": ["ai_autonomy"],
                "properties": {
                  "ai_autonomy": { "const": "full" }
                }
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "capabilities": {
            "required": ["ai_audit"],
            "properties": {
              "ai_audit": { "const": true }
            }
          },
          "ai_native_policy": {
            "required": ["security"],
            "properties": {
              "security": {
                "required": ["audit_retention_days"],
                "properties": {
                  "audit_retention_days": { "minimum": 1 }
                }
              }
            }
          }
        }
      }
    }
  ],
  "additionalProperties": false
}
