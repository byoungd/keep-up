# Rust åŠ é€Ÿå™¨åˆ‡å…¥ç‚¹åˆ†æ

Date: 2026-01-21
Owner: Architecture Team
Status: RFC

---

## å®šä½ï¼šåŠ é€Ÿå™¨/éš”ç¦»å™¨ï¼Œéé‡å†™

æœ¬æ–‡æ¡£åˆ†æ Rust ä½œä¸º TypeScript è¿è¡Œæ—¶"åŠ é€Ÿå™¨"çš„åˆ‡å…¥ç‚¹ï¼Œéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
- ä¸æ›¿æ¢ä¸šåŠ¡é€»è¾‘å±‚ (orchestrator, planning)
- ä¸“æ³¨æ€§èƒ½ç“¶é¢ˆå’Œå®‰å…¨éš”ç¦»
- é€šè¿‡ NAPI-RS æˆ– gRPC sidecar é›†æˆ

---

## 1. è¿è¡Œæ—¶æ²™ç®±/è¿›ç¨‹éš”ç¦» (ä¼˜å…ˆçº§: ğŸ”´ æœ€é«˜)

### ç°çŠ¶
| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | ä½œç”¨ |
|------|------|------|------|
| `sandbox/index.ts` | 1 æ–‡ä»¶ | 262 | preflight/postflight å†³ç­– |
| `@ku0/agent-runtime-sandbox` | å¤–éƒ¨åŒ… | - | æ²™ç®±æ‰§è¡Œ (Docker) |

### é—®é¢˜
- Docker å®¹å™¨å¯åŠ¨æ…¢ (~500ms)
- æ— åŸç”Ÿ OS éš”ç¦» (Seatbelt/Landlock)
- æƒé™æ”¶æ•›ä¾èµ–å®¹å™¨è¾¹ç•Œ

### Rust åˆ‡å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TypeScript Layer                                      â”‚
â”‚  - preflight policy å†³ç­–                               â”‚
â”‚  - postflight telemetry æ”¶é›†                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ NAPI-RS binding
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  codex-sandbox (Rust)                                  â”‚
â”‚  - seatbelt.rs (macOS Seatbelt)                        â”‚
â”‚  - landlock.rs (Linux Landlock)                        â”‚
â”‚  - exec.rs (å‘½ä»¤æ‰§è¡Œ + è¶…æ—¶)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤ç”¨ Codex ä»£ç **: `.tmp/analysis/codex/codex-rs/core/src/seatbelt.rs` (~24KB)

**é¢„æœŸæ”¶ç›Š**:
- æ²™ç®±å¯åŠ¨: 500ms â†’ <10ms
- å†…æ ¸çº§éš”ç¦» (æ— å®¹å™¨å¼€é”€)
- ç»†ç²’åº¦æƒé™æ§åˆ¶ (æ–‡ä»¶/ç½‘ç»œ/è¿›ç¨‹)

---

## 2. ç¬¦å·å›¾/LSP ç´¢å¼• (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

### ç°çŠ¶
| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | ä½œç”¨ |
|------|------|------|------|
| `lsp/symbolGraph.ts` | 1 æ–‡ä»¶ | 214 | ç¬¦å·ç´¢å¼• + æŸ¥è¯¢ |
| `lsp/lspService.ts` | 1 æ–‡ä»¶ | ~500 | LSP å®¢æˆ·ç«¯ |
| `lsp/importGraph.ts` | 1 æ–‡ä»¶ | ~100 | ä¾èµ–å›¾ |

### é—®é¢˜
- JavaScript Map æ€§èƒ½ä¸è¶³ (å¤§å‹é¡¹ç›® >10K ç¬¦å·)
- æ¨¡ç³Šæœç´¢æ˜¯ O(N) éå†
- å†…å­˜å ç”¨é«˜ (V8 å¯¹è±¡å¼€é”€)

### Rust åˆ‡å…¥

```rust
// Rust: é«˜æ€§èƒ½ç¬¦å·ç´¢å¼•
pub struct SymbolIndex {
    trie: FuzzyTrie,           // å‰ç¼€æ ‘æ¨¡ç³Šæœç´¢
    positions: RoaringBitmap,   // ä½å›¾å®šä½
    arena: Bump,               // Arena åˆ†é…å™¨
}

impl SymbolIndex {
    pub fn query(&self, q: &str, limit: usize) -> Vec<Symbol> {
        // O(log N) æŸ¥è¯¢
    }
}
```

**é¢„æœŸæ”¶ç›Š**:
- æŸ¥è¯¢å»¶è¿Ÿ: 50ms â†’ <5ms
- å†…å­˜å ç”¨: é™ä½ 50-70%
- æ”¯æŒå¢é‡æ›´æ–°

---

## 3. ä¸Šä¸‹æ–‡å‹ç¼©/Diff (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

### ç°çŠ¶
| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | ä½œç”¨ |
|------|------|------|------|
| `context/ContextCompactor.ts` | 1 æ–‡ä»¶ | 490 | Token ä¼°ç®— + å‹ç¼© |
| `context/contextManager.ts` | 1 æ–‡ä»¶ | ~700 | ä¸Šä¸‹æ–‡å¸§ç®¡ç† |

### é—®é¢˜
- Token ä¼°ç®—ä¾èµ–å­—ç¬¦ä¸²æ“ä½œ
- diff ç®—æ³•æ˜¯çº¯ JavaScript
- é•¿æ–‡æœ¬å‹ç¼© CPU å¯†é›†

### Rust åˆ‡å…¥

```rust
// Rust: é«˜æ€§èƒ½ diff/å‹ç¼©
use similar::{TextDiff, Algorithm};

pub fn compute_diff(old: &str, new: &str) -> Vec<Change> {
    TextDiff::configure()
        .algorithm(Algorithm::Patience)
        .diff_lines(old, new)
        .iter_all_changes()
        .collect()
}

pub fn compress_context(messages: &[Message]) -> CompressedContext {
    // LZ4/Zstd å‹ç¼©
}
```

**é¢„æœŸæ”¶ç›Š**:
- Diff é€Ÿåº¦: 10x æå‡
- å‹ç¼©æ¯”: Zstd ä¼˜äº JavaScript å®ç°
- Token ä¼°ç®—: tiktoken-rs (æ—  WASM å¼€é”€)

---

## 4. CLI Sidecar (ä¼˜å…ˆçº§: ğŸŸ¢ ä½)

### æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node.js Agent Runtime                                  â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘ã€LLM è°ƒç”¨ã€UI é›†æˆ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ gRPC / Unix Socket
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rust Sidecar Daemon (å•ä¸€é™æ€äºŒè¿›åˆ¶)                    â”‚
â”‚  - sandbox-exec (æƒé™éš”ç¦»)                               â”‚
â”‚  - symbol-index (ç¬¦å·æŸ¥è¯¢)                               â”‚
â”‚  - context-compress (å‹ç¼©)                               â”‚
â”‚  - log-replay (æ—¥å¿—å›æ”¾)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éƒ¨ç½²ä¼˜åŠ¿**:
- å•ä¸€ ~10MB äºŒè¿›åˆ¶
- æ—  Node.js è¿è¡Œæ—¶ä¾èµ–
- å¯ç‹¬ç«‹å‡çº§

---

## 5. å®æ–½è·¯çº¿å›¾

| Phase | æ¨¡å— | é›†æˆæ–¹å¼ | æ—¶é—´ | é£é™© |
|-------|------|----------|------|------|
| **P0** | sandbox-exec | NAPI-RS | 4 å‘¨ | ä½ |
| **P1** | symbol-index | NAPI-RS | 4 å‘¨ | ä¸­ |
| **P2** | context-compress | NAPI-RS | 3 å‘¨ | ä½ |
| **P3** | sidecar daemon | gRPC | 6 å‘¨ | é«˜ |

### P0 è¯¦ç»†æ­¥éª¤

1. **Week 1**: è¯„ä¼° codex-rs æ²™ç®±ä»£ç å¯å¤ç”¨æ€§
2. **Week 2**: åˆ›å»º `packages/sandbox-rs` Rust crate
3. **Week 3**: NAPI-RS ç»‘å®š + é›†æˆæµ‹è¯•
4. **Week 4**: æ›¿æ¢ Docker å®¹å™¨è°ƒç”¨

---

## 6. æŠ€æœ¯å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© | ç†ç”± |
|-------|------|------|
| ç»‘å®šæ–¹å¼ | NAPI-RS | ä½å»¶è¿Ÿï¼Œæ—  IPC å¼€é”€ |
| æ²™ç®±å®ç° | å¤ç”¨ codex-rs | æˆç†Ÿä»£ç ï¼Œå‡å°‘å¼€å‘ |
| ç¬¦å·ç´¢å¼• | tantivy/fst | ç”Ÿäº§éªŒè¯çš„ç´¢å¼•åº“ |
| å‹ç¼©ç®—æ³• | Zstd | é€Ÿåº¦/å‹ç¼©æ¯”å¹³è¡¡ |
| Sidecar é€šä¿¡ | gRPC | è·¨è¯­è¨€æ ‡å‡† |

---

## References

- Codex æ²™ç®±: `.tmp/analysis/codex/codex-rs/core/src/seatbelt.rs`
- å½“å‰æ²™ç®±: `packages/agent-runtime/src/sandbox/`
- ç¬¦å·å›¾: `packages/agent-runtime/src/lsp/symbolGraph.ts`
- ä¸Šä¸‹æ–‡å‹ç¼©: `packages/agent-runtime/src/context/ContextCompactor.ts`
